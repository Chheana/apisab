<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JakLike - Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #0066FF 0%, #0044CC 100%);
            color: white;
            padding: 1.5rem 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .balance-display {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .balance-amount {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .service-type-section {
            margin: 1.5rem 0;
        }
        
        .service-type-title {
            background: white;
            padding: 1rem 1.5rem;
            margin: 0 1rem 1rem 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .package-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 0 1rem 1rem 1rem;
        }
        
        /* Mobile-first responsive grid */
        @media (max-width: 768px) {
            .package-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin: 0 0.5rem 1rem 0.5rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .package-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .package-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .package-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #0066FF;
        }
        
        /* Mobile touch-friendly cards */
        @media (max-width: 768px) {
            .package-card {
                min-height: 180px;
                border-radius: 12px;
            }
        }
        
        .package-header {
            background: linear-gradient(135deg, #0066FF 0%, #0044CC 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            flex-shrink: 0;
        }
        
        .package-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            line-height: 1.3;
        }
        
        .package-price {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        /* Mobile package header */
        @media (max-width: 768px) {
            .package-header {
                padding: 1rem;
            }
            
            .package-name {
                font-size: 1rem;
            }
            
            .package-price {
                font-size: 1.5rem;
            }
        }
        
        .package-body {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .package-description {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.5;
            text-align: center;
        }
        
        .package-details {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
        }
        
        .detail-value {
            color: #333;
        }
        
        .order-btn {
            background: linear-gradient(135deg, #0066FF 0%, #0044CC 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        
        .order-btn:hover {
            transform: translateY(-1px);
            color: white;
        }
        
        /* Mobile package body and button styles */
        @media (max-width: 768px) {
            .package-body {
                padding: 1rem;
            }
            
            .package-details {
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .detail-item {
                padding: 0.75rem;
                font-size: 0.85rem;
            }
            
            .order-btn {
                padding: 1rem;
                font-size: 1.1rem;
                min-height: 52px;
                border-radius: 10px;
            }
        }
        
        .order-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .no-services {
            text-align: center;
            padding: 3rem 1rem;
            color: #666;
        }
        
        .no-services i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ccc;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 0.75rem 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .nav-item {
            text-align: center;
            color: #666;
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        
        .nav-item.active {
            color: #0066FF;
        }
        
        .nav-item i {
            font-size: 1.2rem;
        }
        
        .sync-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin: 0 1rem 1rem 1rem;
            color: #0c5460;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .category-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 1rem 1rem 1rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #0066FF;
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .back-link:hover {
            background: #f0f4ff;
            color: #0044CC;
        }
        
        .category-badge {
            background: linear-gradient(135deg, #0066FF 0%, #0044CC 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .view-all-option {
            text-align: center;
            margin: 0 1rem 1rem 1rem;
        }
        
        .view-all-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #0066FF;
            text-decoration: none;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: 2px solid #0066FF;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .view-all-link:hover {
            background: #0066FF;
            color: white;
            transform: translateY(-1px);
        }
        
        .browse-categories {
            margin: 1.5rem 0;
        }
        
        .section-title {
            background: white;
            padding: 1rem 1.5rem;
            margin: 0 1rem 1rem 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 0 1rem 1rem 1rem;
        }
        
        .category-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            text-decoration: none;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            color: #333;
        }
        
        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin: 0 auto 1rem auto;
        }
        
        .tiktok-card .category-icon {
            background: linear-gradient(45deg, #ff0050, #00f2ea);
        }
        
        .facebook-card .category-icon {
            background: linear-gradient(45deg, #1877f2, #42a5f5);
        }
        
        .telegram-card .category-icon {
            background: linear-gradient(45deg, #0088cc, #00bcd4);
        }
        
        .category-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .category-count {
            font-size: 0.9rem;
            color: #666;
        }
        
        .package-count {
            background: #e9ecef;
            color: #666;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        .package-summary {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem;
            margin: 0;
        }
        
        .package-summary .row {
            align-items: center;
        }
        
        .package-summary strong {
            color: #495057;
        }
        
        .total-cost-summary {
            color: #0066FF;
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        {% if selected_category %}
            <h1>{{ selected_category }} Services</h1>
        {% else %}
            <h1>📦 Available Services</h1>
        {% endif %}
        <div class="balance-display">
            <div class="balance-amount">${{ "%.2f"|format(user.balance) }}</div>
            <small>Available Balance</small>
        </div>
    </div>
    
    <!-- Sync Info -->
    <div class="sync-info">
        <i class="fas fa-sync-alt"></i>
        Balance automatically synced with your bot account
    </div>
    
    <!-- Category Navigation (only show when viewing specific category) -->
    {% if selected_category %}
    <div class="category-nav">
        <a href="/dashboard" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Categories
        </a>
        <div class="category-badge">
            <i class="fas fa-tag"></i> {{ selected_category }}
        </div>
    </div>
    
    <!-- View All Services Option -->
    <div class="view-all-option">
        <a href="/services" class="view-all-link">
            <i class="fas fa-th-large"></i> View All Services
        </a>
    </div>
    {% endif %}
    
    <!-- Browse Categories (only show when viewing all services) -->
    {% if not selected_category %}
    <div class="browse-categories">
        <div class="section-title">Browse by Category</div>
        <div class="category-grid">
            <a href="/services/TikTok" class="category-card tiktok-card">
                <div class="category-icon">
                    <i class="fab fa-tiktok"></i>
                </div>
                <div class="category-name">TikTok</div>
                <div class="category-count">{{ services_by_category.get('TikTok', [])|length }} packages</div>
            </a>
            
            <a href="/services/Facebook" class="category-card facebook-card">
                <div class="category-icon">
                    <i class="fab fa-facebook"></i>
                </div>
                <div class="category-name">Facebook</div>
                <div class="category-count">{{ services_by_category.get('Facebook', [])|length }} packages</div>
            </a>
            
            <a href="/services/Telegram" class="category-card telegram-card">
                <div class="category-icon">
                    <i class="fab fa-telegram"></i>
                </div>
                <div class="category-name">Telegram</div>
                <div class="category-count">{{ services_by_category.get('Telegram', [])|length }} packages</div>
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Services by Service Type -->
    {% if services_by_category %}
        {% for category, services in services_by_category.items() %}
        <div class="service-type-section">
            <div class="service-type-title">
                {% if category == 'TikTok' %}
                    <i class="fab fa-tiktok" style="color: #ff0050;"></i>
                {% elif category == 'Facebook' %}
                    <i class="fab fa-facebook" style="color: #1877f2;"></i>
                {% elif category == 'Telegram' %}
                    <i class="fab fa-telegram" style="color: #0088cc;"></i>
                {% elif category == 'Instagram' %}
                    <i class="fab fa-instagram" style="color: #e4405f;"></i>
                {% elif category == 'YouTube' %}
                    <i class="fab fa-youtube" style="color: #ff0000;"></i>
                {% else %}
                    <i class="fas fa-star" style="color: #ffc107;"></i>
                {% endif %}
                {{ category }} Services
                <span class="package-count">{{ services|length }} packages</span>
            </div>
            
            <!-- Group services by service type -->
            {% set service_types = {} %}
            {% for service in services %}
                {% set service_type = service.service_type %}
                {% if service_type not in service_types %}
                    {% set _ = service_types.update({service_type: []}) %}
                {% endif %}
                {% set _ = service_types[service_type].append(service) %}
            {% endfor %}
            
            {% for service_type, packages in service_types.items() %}
            <div class="package-grid">
                {% for package in packages %}
                <div class="package-card">
                    <div class="package-header">
                        <div class="package-name">{{ package.name }}</div>
                        <div class="package-price">${{ "%.2f"|format(package.price) }}</div>
                    </div>
                    
                    <div class="package-body">
                        {% if package.description %}
                        <div class="package-description">{{ package.description }}</div>
                        {% endif %}
                        
                        <div class="package-details">
                            <div class="detail-item">
                                <span class="detail-label">Package Size:</span>
                                <span class="detail-value">{{ package.quantity }}</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="detail-label">Service Type:</span>
                                <span class="detail-value">{{ package.service_type|title }}</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="detail-label">Package Price:</span>
                                <span class="detail-value">${{ "%.2f"|format(package.price) }}</span>
                            </div>
                        </div>
                        
                        <!-- Debug info (remove in production) -->
                        <div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem; text-align: center;">
                            ID: {{ package.id }} | Qty: {{ package.quantity }} | Price: {{ package.price }}
                        </div>
                        
                        <button class="order-btn" onclick="orderService({{ package.id }}, '{{ package.name|replace("'", "\\'") }}', {{ package.price }}, {{ package.quantity }})">
                            <i class="fas fa-shopping-cart"></i> Order This Package
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    {% else %}
        <div class="no-services">
            <i class="fas fa-box-open"></i>
            <h3>No Services Available</h3>
            <p>Services will be added soon. Please check back later.</p>
        </div>
    {% endif %}
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="/dashboard" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="/services" class="nav-item {% if not selected_category %}active{% endif %}">
            <i class="fas fa-box"></i>
            <span>All Services</span>
        </a>
        <a href="/orders" class="nav-item">
            <i class="fas fa-list"></i>
            <span>Orders</span>
        </a>
        <a href="/balance" class="nav-item">
            <i class="fas fa-wallet"></i>
            <span>Balance</span>
        </a>
        <a href="/profile" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Account</span>
        </a>
    </div>

    <!-- Order Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Place Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <!-- Package Summary -->
                <div class="package-summary">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Package:</strong> <span id="packageSummary"></span>
                        </div>
                        <div class="col-md-6 text-end">
                            <strong>Total Cost:</strong> <span id="totalCostSummary" class="total-cost-summary"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <input type="hidden" id="serviceId" name="service_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Service Package</label>
                            <input type="text" class="form-control" id="serviceName" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Package Size</label>
                            <input type="text" class="form-control" id="quantity" name="quantity" readonly>
                            <small class="form-text text-muted">Fixed package size - cannot be changed</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Package Price</label>
                            <input type="text" class="form-control" id="packagePrice" readonly>
                            <small class="form-text text-muted">Fixed package price</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Link</label>
                            <input type="url" class="form-control" id="link" name="link" placeholder="https://..." required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Additional Information (Optional)</label>
                            <textarea class="form-control" id="additionalInfo" name="additional_info" rows="3" placeholder="Any special requirements..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total Cost</label>
                            <input type="text" class="form-control" id="totalCost" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitOrder()">Place Order</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentServicePrice = 0;
        
        function orderService(serviceId, serviceName, price, quantity) {
            console.log('Ordering service:', { serviceId, serviceName, price, quantity });
            
            // Validate inputs
            if (!serviceId || !serviceName || price === undefined || quantity === undefined) {
                console.error('Invalid parameters:', { serviceId, serviceName, price, quantity });
                alert('Error: Invalid service information. Please try again.');
                return;
            }
            
            currentServicePrice = price;
            
            // Set form values
            document.getElementById('serviceId').value = serviceId;
            document.getElementById('serviceName').value = serviceName;
            document.getElementById('quantity').value = quantity;
            document.getElementById('packagePrice').value = `$${price.toFixed(2)}`;
            document.getElementById('packageSummary').textContent = serviceName;
            document.getElementById('totalCostSummary').textContent = `$${price.toFixed(2)}`;
            document.getElementById('link').value = '';
            document.getElementById('additionalInfo').value = '';
            
            // Update total cost
            updateTotalCost();
            
            // Show modal
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('orderModal'));
            modal.show();
            
            console.log('Modal opened with values:', {
                serviceId: document.getElementById('serviceId').value,
                serviceName: document.getElementById('serviceName').value,
                quantity: document.getElementById('quantity').value,
                price: currentServicePrice
            });
        }
        
        function updateTotalCost() {
            // Fixed package price - no calculation needed
            document.getElementById('totalCost').value = `$${currentServicePrice.toFixed(2)}`;
        }
        
        async function submitOrder() {
            const formData = new FormData(document.getElementById('orderForm'));
            
            // Validate form data
            const serviceId = formData.get('service_id');
            const quantity = formData.get('quantity');
            const link = formData.get('link');
            
            if (!serviceId || !quantity || !link) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (!link.startsWith('http')) {
                alert('Please enter a valid URL starting with http:// or https://');
                return;
            }
            
            try {
                const response = await fetch('/api/place_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_id: serviceId,
                        quantity: parseInt(quantity),
                        link: link,
                        additional_info: formData.get('additional_info') || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('orderModal'));
                    modal.hide();
                    
                    // Redirect to success page
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        // Fallback to alert if no redirect URL
                        alert('🎉 Order placed successfully!\n\nOrder ID: ' + data.order_id + '\nTotal Cost: $' + data.total_cost.toFixed(2) + '\nNew Balance: $' + data.new_balance.toFixed(2));
                        location.reload();
                    }
                } else {
                    alert('❌ Error: ' + data.error);
                }
            } catch (error) {
                alert('❌ Error placing order: ' + error.message);
            }
        }
        
        // Auto-refresh balance every 30 seconds
        setInterval(async () => {
            try {
                const response = await fetch('/api/sync_balance');
                const data = await response.json();
                if (data.success) {
                    document.querySelector('.balance-amount').textContent = `$${data.balance.toFixed(2)}`;
                }
            } catch (error) {
                console.log('Balance sync failed:', error);
            }
        }, 30000);
    </script>
</body>
</html>
